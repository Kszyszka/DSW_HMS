{% extends 'base.html' %}

{% block title %}Utwórz Rezerwację (Pracownik) - HMS{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-md-8 offset-md-2">
        <h2><i class="bi bi-plus-circle"></i> Nowa Rezerwacja (Pracownik)</h2>
        <hr>
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="guest_id" class="form-label">Wybierz istniejącego gościa (opcjonalnie)</label>
                        <select class="form-select" id="guest_id" name="guest_id">
                            <option value="">Utwórz nowego gościa poniżej</option>
                            {% for g in guests %}
                            <option value="{{ g.id }}" data-name="{{ g.user.first_name }}" data-surname="{{ g.user.last_name }}" data-email="{{ g.user.email }}" data-phone="{{ g.phone_number }}">{{ g.user.first_name }} {{ g.user.last_name }} — {{ g.user.email }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Imię</label>
                            <input type="text" class="form-control" id="name" name="name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="surname" class="form-label">Nazwisko</label>
                            <input type="text" class="form-control" id="surname" name="surname">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Telefon</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                    </div>

                    <hr>

                    <div class="mb-3">
                        <label for="room_id" class="form-label">Pokój</label>
                        <select class="form-select" id="room_id" name="room_id" required>
                            <option value="">Wybierz pokój</option>
                            {% for room in available_rooms %}
                            <option value="{{ room.id }}" data-price="{{ room.price }}" data-capacity="{{ room.capacity }}">Pokój {{ room.number }} - {{ room.get_room_type_display }} ({{ room.price }} PLN/noc) — pojemność: {{ room.capacity }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="check_in_date" class="form-label">Data zameldowania</label>
                            <input type="date" class="form-control" id="check_in_date" name="check_in_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="check_out_date" class="form-label">Data wymeldowania</label>
                            <input type="date" class="form-control" id="check_out_date" name="check_out_date" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Liczba gości</label>
                            <input type="number" min="1" max="10" name="number_of_guests" id="number_of_guests" class="form-control" value="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Forma płatności</label>
                            <select class="form-select" name="payment_method" id="payment_method">
                                <option value="cash">Gotówka</option>
                                <option value="online">Płatność online (test)</option>
                            </select>
                        </div>
                    </div>

                    <div id="no_rooms_alert" class="alert alert-danger" style="display:none;">
                        Brak dostępnych pokoi dla wybranej liczby gości.
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Uwagi (opcjonalnie)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>

                    {% if conflict_room %}
                        <div class="alert alert-warning">
                            <strong>Konflikt rezerwacji dla pokoju {{ conflict_room.number }}</strong>
                            <p>Znaleziona rezerwacja(je):</p>
                            <ul>
                                {% for cr in conflict_reservations %}
                                <li>#{{ cr.id }} — {{ cr.check_in_date }} → {{ cr.check_out_date }} — status: {{ cr.get_status_display }}</li>
                                {% endfor %}
                            </ul>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="confirm_force" id="confirm_force" value="yes">
                                <label class="form-check-label" for="confirm_force">Potwierdzam wymuszenie i przypisanie rezerwacji mimo konfliktu</label>
                            </div>
                        </div>
                    {% endif %}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Utwórz Rezerwację
                        </button>
                        <a href="{% url 'employee:reservations' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Anuluj
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Populate guest fields when selecting existing
    const guestSelect = document.getElementById('guest_id');
    const nameInput = document.getElementById('name');
    const surnameInput = document.getElementById('surname');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');

    if (guestSelect){
        guestSelect.addEventListener('change', function(){
            const opt = this.options[this.selectedIndex];
            if (!opt || !opt.value){
                nameInput.value = '';
                surnameInput.value = '';
                emailInput.value = '';
                phoneInput.value = '';
                return;
            }
            nameInput.value = opt.dataset.name || '';
            surnameInput.value = opt.dataset.surname || '';
            emailInput.value = opt.dataset.email || '';
            phoneInput.value = opt.dataset.phone || '';
        });
    }

    // Date and availability logic (same as guest create)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('check_in_date').setAttribute('min', today);
    document.getElementById('check_out_date').setAttribute('min', today);

    const numberInput = document.getElementById('number_of_guests');
    const roomSelect = document.getElementById('room_id');
    const noRoomsAlert = document.getElementById('no_rooms_alert');
    const submitButton = document.querySelector('button[type="submit"]');
    const checkInInput = document.getElementById('check_in_date');
    const checkOutInput = document.getElementById('check_out_date');

    function datesValid(){
        return checkInInput.value && checkOutInput.value && (checkInInput.value < checkOutInput.value);
    }

    async function fetchRoomsForDates(){
        // Jeśli daty nie są pełne/poprawne, nie pytaj API, tylko filtruj lokalnie to co jest
        if (!datesValid()) return;
        
        roomSelect.innerHTML = '<option value="">Sprawdzam dostępność...</option>';
        roomSelect.disabled = true;
        
        const guests = parseInt(numberInput.value || '1');
        const params = new URLSearchParams({
            check_in_date: checkInInput.value,
            check_out_date: checkOutInput.value,
            number_of_guests: guests
        });
        
        const res = await fetch(`/api/rooms-availability/?${params.toString()}`);
        if (!res.ok) {
            roomSelect.disabled = false;
            return;
        }
        const data = await res.json();

        roomSelect.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Wybierz pokój';
        roomSelect.appendChild(placeholder);
        roomSelect.disabled = false;

        let any = false;

        // POPRAWKA: Używamy poprawnej nazwy pola z API
        if ((!data.available_now || data.available_now.length === 0) && (!data.available_later || data.available_later.length === 0)){
            if (data.nearest_available_start){
                noRoomsAlert.textContent = `Brak wolnych pokoi w danym terminie, najbliższy dostępny termin to ${data.nearest_available_start}`;
            } else {
                noRoomsAlert.textContent = 'Brak wolnych pokoi w danym terminie.';
            }
            noRoomsAlert.style.display = 'block';
            submitButton.disabled = true;
            return;
        }

        if (data.capacity_issue){
            noRoomsAlert.textContent = `Brak dostępnych pokoi dla wybranej liczby gości (${guests}) w tym terminie.`;
            noRoomsAlert.style.display = 'block';
            submitButton.disabled = true;
            return;
        }

        if (data.available_now && data.available_now.length){
            data.available_now.forEach(r=>{
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.dataset.price = r.price;
                opt.dataset.capacity = r.capacity;
                opt.textContent = `Pokój ${r.number} - ${r.room_type} (${r.price} PLN/noc)`;
                roomSelect.appendChild(opt);
                any = true;
            });
        }

        if (data.available_later && data.available_later.length){
            data.available_later.forEach(r=>{
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.dataset.price = r.price;
                opt.dataset.capacity = r.capacity;
                const note = r.occupied_until ? ` — proponowane (obecnie zajęty do ${r.occupied_until})` : ' — proponowane (obecnie zajęty)';
                opt.textContent = `Pokój ${r.number} - ${r.room_type} (${r.price} PLN/noc) ${note}`;
                roomSelect.appendChild(opt);
                any = true;
            });
        }

        noRoomsAlert.style.display = any ? 'none' : 'block';
        submitButton.disabled = !any;
    }

    if (checkInInput && checkOutInput){
        checkInInput.addEventListener('change', function() {
            roomSelect.innerHTML = '<option value="">Wybierz daty...</option>';
            fetchRoomsForDates();
        });
        checkOutInput.addEventListener('change', function() {
            roomSelect.innerHTML = '<option value="">Wybierz daty...</option>';
            fetchRoomsForDates();
        });
    }

    numberInput.addEventListener('input', fetchRoomsForDates);

</script>
{% endblock %}
{% endblock %}